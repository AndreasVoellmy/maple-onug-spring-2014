<!DOCTYPE html>
<head>
<link rel="stylesheet" href="/maple/bootstrap/css/bootstrap.css">
<script type="text/javascript" src="/maple/d3/d3.v3.js" charset="utf-8"></script>
<style>
body {
  font-family: "Helvetica Neue", Helvetica, Aria, sans-serif;
}

svg {
  font-size: 10px;
}

.axis path,
.axis line {
  fill: none;
  stroke: black;
  shape-rendering: crispEdges;
}

path.data {
  fill: transparent;
  stroke: grey;
  stroke-width: 2;
}

path.high {
    stroke: red; 
}

path.low {
    stroke: blue;
}

#initial svg .data-1 {
  stroke: rgba(128, 128, 128, 0.4);
}

.group {
    height 60px;
}

.group textarea, .group button, .group div {
    float: left;
    margin: 2px;
}

button {
    width: 100%;
    height: 30px;
}

textarea {
    width: 40%;
    height: 60px;
}

#legend {
    float: left;
    width: 40%;
}
</style>
</head>

<body>
    <script>
        var margin = { 'top' : 20, 'bottom' : 20, 'right' : 20, 'left' : 80 },
            height = 300,
            width = 800,
            max_points = 30;

        var xscale = d3.scale.linear().domain([0, max_points - 1]).range([0, width - margin.right - margin.left]),
            yscale = d3.scale.linear().domain([0, 100]).range([height - margin.top - margin.bottom, 0]);

        var xaxis = d3.svg.axis()
            .scale(xscale)
            .orient('bottom')

        var yaxis = d3.svg.axis()
            .scale(yscale)
            .orient('left')

        function chart(selection) { 
          selection.each(function(data, i) {
            yscale = yscale.domain([0, d3.max(data, function(d) { return d.hi +
          d.lo; }) || 10]);
            yaxis = yaxis.scale(yscale);
            var svg = d3.select(this).selectAll('svg')
                .data([data]);

            var svge = svg.enter().append('svg')
                .attr('width', width)
                .attr('height', height)
              .append('g')
                .attr('id', 'wrapper')
                .attr('transform', 'translate(' + [margin.left, margin.top] + ')');

            svge.append('g')
                .attr('class', 'x axis')
                .attr('transform', 'translate(' + [0, height - margin.bottom - margin.top] + ')');

            svge.append('g')
                .attr('class', 'y axis');

            svg.select('#wrapper .x.axis').call(xaxis);
            svg.select('#wrapper .y.axis').call(yaxis);

            var both = svg.select('#wrapper').selectAll('path.both')
                .data(function(d) { return [d]; });

            both.enter().append('path')
                .attr('class', 'data both')

            both
                .attr('d', d3.svg.line()
                  .x(function(d, i) { return xscale(i); })
                  .y(function(d, i) { return yscale(d.hi + d.lo); }))


            var high = svg.select('#wrapper').selectAll('path.high')
                .data(function(d) { return [d]; });

            high.enter().append('path')
                .attr('class', 'data high')

            high
                .attr('d', d3.svg.line()
                  .x(function(d, i) { return xscale(i); })
                  .y(function(d, i) { return yscale(d.hi); }))

            var low = svg.select('#wrapper').selectAll('path.low')
                .data(function(d) { return [d]; });

            low.enter().append('path')
                .attr('class', 'data low')

            low
                .attr('d', d3.svg.line()
                  .x(function(d, i) { return xscale(i); })
                  .y(function(d, i) { return yscale(d.lo); }))

            
          });
        }

        var byt = { last : null, data : [] },
            last_hi = null,
            last_lo = null;
/*
        function update(latest) {
            var hi_pkt_diff;
            var hi_byt_diff;

            if (last_hi == null) {
              hi_pkt_diff = 0;
              last_hi = latest.HIGH;
            } else {
              if (null == latest.HIGH) {
                hi_pkt_diff = 0;
                hi_byt_diff = 0;
              } else {
                hi_pkt_diff = latest.HIGH[0] - last_hi[0];
                hi_byt_diff = latest.HIGH[1] - last_hi[1];
                last_hi_pkt = latest.HIGH;
              }
            }

            var lo_pkt_diff;
            var lo_byt_diff;

            if (last_lo == null) {
              lo_pkt_diff = 0;
              last_lo = latest.LOW;
            } else {
              if (null == latest.LOW) {
                lo_pkt_diff = 0;
                lo_byt_diff = 0;
              } else {
                lo_pkt_diff = latest.LOW[0] - last_lo[0];
                lo_byt_diff = latest.LOW[1] - last_lo[1];
                last_lo_pkt = latest.LOW;
              }
            }
           // alert(JSON.stringify({ hi: hi_byt_diff, lo: lo_byt_diff }));
            pkt.data.push( { hi: hi_pkt_diff, lo: lo_pkt_diff } );
            byt.data.push( { hi: hi_byt_diff, lo: lo_byt_diff } );
        } 
*/
        function update(latest) {

            // push data always.
            // determine what to push onto data

            var byt_latest = { hi: (latest.HIGH ? latest.HIGH[1] : byt.last.hi)
                             , lo : (latest.LOW ? latest.LOW[1] : byt.last.lo) };
           
            if (byt.last === null) {
                byt.last = byt_latest
            } else {
                byt.data.push({ hi : byt_latest.hi - byt.last.hi, lo : byt_latest.lo - byt.last.lo });
                if (byt.data.length > max_points) { byt.data.shift(); }
                byt.last = byt_latest;
            }
        }

        d3.select('body').datum(byt.data).call(chart);

        var interval = setInterval(function() {
          d3.json('/flowcounters', function(data) {
            update(data);
JSON.stringify(byt.data);
            d3.select('body').datum(byt.data).call(chart);
          })
        }, 2000);
    </script>
    <div class="group">
      
      <textarea rows="3"></textarea>
      <div>
          <button id="set">add app policy</button>
          <button id="clear">default app policies</button>
      </div>

      <table id="legend">
          <tr>
              <td style="background-color:gray">&nbsp;</td>
              <td>total throughput</td>
          </tr>
          <tr>
              <td style="background-color:red">&nbsp;</td>
              <td>high quality throughput</td>
          </tr>
          <tr>
              <td style="background-color:blue">&nbsp;</td>
              <td>low quality throughput</td>
          </tr>
      </table>
    </div>

    <script>
        d3.select('.group button#set').on('click', function() {
            var data = JSON.stringify({ "component": "policy", "method": "write", "value":[{"trafficType":{"asserts":[{"field":"IP_DST","arg1":-1062731771,"arg2":32}]},"quality":0}] });
            d3.xhr('/db')
                .header("Content-Type", "application/json")
                .post(data, function(error, data) { });
        });

        d3.select('.group button#clear').on('click', function() {
            var data = JSON.stringify({ "component": "policy", "method": "write", "value":[] });
            d3.xhr('/db')
                .header("Content-Type", "application/json")
                .post(data, function(error, data) { });
        });
    </script>
</body>
